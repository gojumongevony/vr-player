<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Local VR Player - Full Immersion</title>

<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/oscarmarinmiro/aframe-stereo-component@master/dist/aframe-stereo-component.min.js"></script>

<style>
body {
    margin: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

#startup {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.9);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    gap: 20px;
}

.mode-group {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.mode-option {
    padding: 12px 24px;
    background: rgba(255,255,255,0.1);
    border: 2px solid #555;
    border-radius: 8px;
    cursor: pointer;
}

.mode-option.active {
    background: #0078d7;
    border-color: #0078d7;
}

.label {
    font-size: 14px;
    color: #aaa;
    margin-top: 10px;
}

#choose-btn {
    padding: 14px 28px;
    font-size: 18px;
    background: #0078d7;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

#controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    padding: 10px 20px;
    border-radius: 10px;
    color: white;
    z-index: 10;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

#seek-bar {
    width: 600px;
    max-width: 90vw;
}

button {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
}

#error-msg {
    color: #ff4444;
    display: none;
    margin-top: 10px;
}
</style>
</head>

<body>

<!-- ---------- Startup ---------- -->
<div id="startup">
    <h1>Local VR Player</h1>

    <div>
        <div class="label">Video Type</div>
        <div class="mode-group">
            <div id="opt-180" class="mode-option active">180° VR</div>
            <div id="opt-360" class="mode-option">360° VR</div>
        </div>
    </div>

    <div>
        <div class="label">Stereo Format</div>
        <div class="mode-group">
            <div id="opt-mono" class="mode-option active">Mono</div>
            <div id="opt-sbs" class="mode-option">Side-by-Side</div>
            <div id="opt-tb" class="mode-option">Top-Bottom</div>
        </div>
    </div>

    <button id="choose-btn">Choose Video File</button>
    <input id="file-input" type="file" accept="video/mp4,video/webm,video/ogg" hidden>
    <div id="error-msg"></div>
</div>

<!-- ---------- 2D Controls ---------- -->
<div id="controls">
    <div>
        <button id="enter-vr">Enter VR</button>
        <button id="play-pause">Play</button>
        <button id="mute">Mute</button>
        <button id="zoom-in">Zoom In</button>
        <button id="zoom-out">Zoom Out</button>
    </div>
    <input type="range" id="seek-bar" min="0" max="100" step="0.1">
    <div id="time-display">00:00 / 00:00</div>
</div>

<!-- ---------- A-Frame Scene ---------- -->
<a-scene embedded vr-mode-ui="enabled: false" style="width:100vw; height:100vh;">
    <a-assets>
        <video
            id="vr-video"
            autoplay
            muted
            loop
            crossorigin="anonymous"
            playsinline
            webkit-playsinline>
        </video>
    </a-assets>

    <!-- 180 degree sphere with stereo support - Left Eye -->
    <a-entity
        id="video-sphere-180-left"
        geometry="primitive: sphere; radius: 100; segmentsWidth: 64; segmentsHeight: 64"
        material="shader: flat; side: back; src: #vr-video; npot: true"
        rotation="0 180 0"
        layers="type: left"
        visible="true">
    </a-entity>

    <!-- 180 degree sphere with stereo support - Right Eye -->
    <a-entity
        id="video-sphere-180-right"
        geometry="primitive: sphere; radius: 100; segmentsWidth: 64; segmentsHeight: 64"
        material="shader: flat; side: back; src: #vr-video; npot: true"
        rotation="0 180 0"
        layers="type: right"
        visible="true">
    </a-entity>

    <!-- 360 degree sphere with stereo support - Left Eye -->
    <a-entity
        id="video-sphere-360-left"
        geometry="primitive: sphere; radius: 100; segmentsWidth: 64; segmentsHeight: 64"
        material="shader: flat; side: back; src: #vr-video"
        rotation="0 0 0"
        layers="type: left"
        visible="false">
    </a-entity>

    <!-- 360 degree sphere with stereo support - Right Eye -->
    <a-entity
        id="video-sphere-360-right"
        geometry="primitive: sphere; radius: 100; segmentsWidth: 64; segmentsHeight: 64"
        material="shader: flat; side: back; src: #vr-video"
        rotation="0 0 0"
        layers="type: right"
        visible="false">
    </a-entity>

    <a-entity id="camera" camera look-controls position="0 1.6 0" rotation="0 0 0">
        <a-cursor fuse="true" fuse-timeout="1500"></a-cursor>
    </a-entity>

    <!-- ---------- VR Controls ---------- -->
    <a-entity id="vr-controls" visible="false" position="0 -0.5 -1.5" rotation="-30 0 0">
        <a-plane id="vr-play" class="clickable" width="0.6" height="0.3" position="-1.2 0.4 0" color="#333">
            <a-text value="Play" align="center" color="white" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="vr-mute" class="clickable" width="0.6" height="0.3" position="-0.4 0.4 0" color="#333">
            <a-text value="Mute" align="center" color="white" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="vr-zoom-in" class="clickable" width="0.6" height="0.3" position="0.4 0.4 0" color="#333">
            <a-text value="Zoom +" align="center" color="white" position="0 0 0.01"></a-text>
        </a-plane>

        <a-plane id="vr-zoom-out" class="clickable" width="0.6" height="0.3" position="1.2 0.4 0" color="#333">
            <a-text value="Zoom -" align="center" color="white" position="0 0 0.01"></a-text>
        </a-plane>

        <a-text id="vr-time" value="00:00 / 00:00" align="center" color="white" position="0 -0.2 0"></a-text>
    </a-entity>
</a-scene>

<script>
const startup = document.getElementById('startup');
const chooseBtn = document.getElementById('choose-btn');
const fileInput = document.getElementById('file-input');
const video = document.getElementById('vr-video');
const scene = document.querySelector('a-scene');
const controls = document.getElementById('controls');
const errorMsg = document.getElementById('error-msg');

const enterVrBtn = document.getElementById('enter-vr');
const playPauseBtn = document.getElementById('play-pause');
const muteBtn = document.getElementById('mute');
const seekBar = document.getElementById('seek-bar');
const timeDisplay = document.getElementById('time-display');
const zoomInBtn = document.getElementById('zoom-in');
const zoomOutBtn = document.getElementById('zoom-out');
const camera = document.getElementById('camera');

const vrControls = document.getElementById('vr-controls');
const vrPlayText = document.querySelector('#vr-play a-text');
const vrMuteText = document.querySelector('#vr-mute a-text');
const vrTimeText = document.getElementById('vr-time');

let fov = 80;
let is180Mode = true;
let stereoMode = 'mono'; // 'mono', 'sbs' (side-by-side), 'tb' (top-bottom)

/* ---------- Mode Selection ---------- */
const opt180 = document.getElementById('opt-180');
const opt360 = document.getElementById('opt-360');
const optMono = document.getElementById('opt-mono');
const optSBS = document.getElementById('opt-sbs');
const optTB = document.getElementById('opt-tb');
const sphere180Left = document.getElementById('video-sphere-180-left');
const sphere180Right = document.getElementById('video-sphere-180-right');
const sphere360Left = document.getElementById('video-sphere-360-left');
const sphere360Right = document.getElementById('video-sphere-360-right');

opt180.onclick = () => {
    opt180.classList.add('active');
    opt360.classList.remove('active');
    is180Mode = true;
    sphere180.setAttribute('visible', 'true');
    sphere360.setAttribute('visible', 'false');
};

opt360.onclick = () => {
    opt360.classList.add('active');
    opt180.classList.remove('active');
    is180Mode = false;
    sphere180.setAttribute('visible', 'false');
    sphere360.setAttribute('visible', 'true');
};

/* ---------- Stereo Mode Selection ---------- */
optMono.onclick = () => {
    optMono.classList.add('active');
    optSBS.classList.remove('active');
    optTB.classList.remove('active');
    stereoMode = 'mono';
};

optSBS.onclick = () => {
    optMono.classList.remove('active');
    optSBS.classList.add('active');
    optTB.classList.remove('active');
    stereoMode = 'sbs';
};

optTB.onclick = () => {
    optMono.classList.remove('active');
    optSBS.classList.remove('active');
    optTB.classList.add('active');
    stereoMode = 'tb';
};

/* ---------- Video Processing ---------- */
function processVideoFrame() {
    if (video.paused || video.ended) return;
    
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    
    // Adjust canvas size based on stereo mode
    if (stereoMode === 'sbs') {
        // Side-by-side: use left half only
        videoCanvas.width = vw / 2;
        videoCanvas.height = vh;
        ctx.drawImage(video, 0, 0, vw / 2, vh, 0, 0, vw / 2, vh);
    } else if (stereoMode === 'tb') {
        // Top-bottom: use top half only
        videoCanvas.width = vw;
        videoCanvas.height = vh / 2;
        ctx.drawImage(video, 0, 0, vw, vh / 2, 0, 0, vw, vh / 2);
    } else {
        // Mono: use full video
        videoCanvas.width = vw;
        videoCanvas.height = vh;
        ctx.drawImage(video, 0, 0, vw, vh);
    }
    
    requestAnimationFrame(processVideoFrame);
}

video.onplay = () => {
    processVideoFrame();
};

/* ---------- File Load ---------- */
chooseBtn.onclick = () => fileInput.click();

fileInput.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('video/')) {
        errorMsg.textContent = 'Please select a valid video file';
        errorMsg.style.display = 'block';
        return;
    }

    errorMsg.style.display = 'none';
    video.src = URL.createObjectURL(file);
    video.load();

    startup.style.display = 'none';
    controls.style.display = 'flex';

    video.onloadeddata = () => {
        video.muted = true;
        video.play().catch(err => {
            console.error('Playback error:', err);
        });
    };

    video.onerror = () => {
        startup.style.display = 'flex';
        controls.style.display = 'none';
        errorMsg.textContent = 'Error loading video file';
        errorMsg.style.display = 'block';
    };
};

/* ---------- VR Toggle ---------- */
enterVrBtn.onclick = () => {
    scene.is('vr-mode') ? scene.exitVR() : scene.enterVR();
};

scene.addEventListener('enter-vr', () => {
    controls.style.display = 'none';
    vrControls.setAttribute('visible', true);
    enterVrBtn.textContent = 'Exit VR';
});

scene.addEventListener('exit-vr', () => {
    controls.style.display = 'flex';
    vrControls.setAttribute('visible', false);
    enterVrBtn.textContent = 'Enter VR';
});

/* ---------- Playback ---------- */
function togglePlay() {
    if (video.paused) {
        video.play().catch(err => console.error('Play error:', err));
    } else {
        video.pause();
    }
    const label = video.paused ? 'Play' : 'Pause';
    playPauseBtn.textContent = label;
    vrPlayText.setAttribute('value', label);
}

function toggleMute() {
    video.muted = !video.muted;
    const label = video.muted ? 'Unmute' : 'Mute';
    muteBtn.textContent = label;
    vrMuteText.setAttribute('value', label);
}

playPauseBtn.onclick = togglePlay;
muteBtn.onclick = toggleMute;

/* ---------- Zoom ---------- */
function zoomIn() {
    fov = Math.max(30, fov - 10);
    camera.setAttribute('camera', `fov: ${fov}`);
}

function zoomOut() {
    fov = Math.min(120, fov + 10);
    camera.setAttribute('camera', `fov: ${fov}`);
}

zoomInBtn.onclick = zoomIn;
zoomOutBtn.onclick = zoomOut;

/* ---------- VR Control Events (A-Frame click events) ---------- */
scene.addEventListener('loaded', () => {
    const vrPlay = document.getElementById('vr-play');
    const vrMute = document.getElementById('vr-mute');
    const vrZoomIn = document.getElementById('vr-zoom-in');
    const vrZoomOut = document.getElementById('vr-zoom-out');

    vrPlay.addEventListener('click', togglePlay);
    vrMute.addEventListener('click', toggleMute);
    vrZoomIn.addEventListener('click', zoomIn);
    vrZoomOut.addEventListener('click', zoomOut);

    // Add hover effects
    const clickables = document.querySelectorAll('.clickable');
    clickables.forEach(el => {
        el.addEventListener('mouseenter', () => {
            el.setAttribute('color', '#0078d7');
        });
        el.addEventListener('mouseleave', () => {
            el.setAttribute('color', '#333');
        });
    });
    
    // Setup all spheres with proper geometry and UV mapping
    setupSphere(sphere180Left, true, 'left');
    setupSphere(sphere180Right, true, 'right');
    setupSphere(sphere360Left, false, 'left');
    setupSphere(sphere360Right, false, 'right');
});

function setupSphere(sphereEl, is180, eye) {
    const mesh = sphereEl.getObject3D('mesh');
    if (!mesh) return;
    
    let geometry;
    if (is180) {
        // Create 180-degree hemisphere
        geometry = new THREE.SphereGeometry(
            100,
            64,
            64,
            -Math.PI / 2,   // phiStart (-90 degrees)
            Math.PI,        // phiLength (180 degrees horizontal)
            0,              // thetaStart
            Math.PI         // thetaLength (180 degrees vertical)
        );
    } else {
        // Full 360 sphere
        geometry = new THREE.SphereGeometry(100, 64, 64);
    }
    
    // Apply UV mapping based on stereo mode and eye
    const uvAttribute = geometry.attributes.uv;
    for (let i = 0; i < uvAttribute.count; i++) {
        const u = uvAttribute.getX(i);
        const v = uvAttribute.getY(i);
        
        if (stereoMode === 'sbs') {
            // Side-by-side: left eye uses left half (0-0.5), right eye uses right half (0.5-1.0)
            if (eye === 'left') {
                uvAttribute.setX(i, u * 0.5);
            } else {
                uvAttribute.setX(i, 0.5 + u * 0.5);
            }
        } else if (stereoMode === 'tb') {
            // Top-bottom: left/top eye uses top half, right/bottom eye uses bottom half
            if (eye === 'left') {
                uvAttribute.setY(i, v * 0.5);
            } else {
                uvAttribute.setY(i, 0.5 + v * 0.5);
            }
        }
        // For mono mode, leave UVs as-is (full texture)
    }
    uvAttribute.needsUpdate = true;
    
    mesh.geometry = geometry;
}

/* ---------- Progress ---------- */
video.ontimeupdate = () => {
    const p = video.currentTime / video.duration || 0;
    seekBar.value = p * 100;
    const t = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
    timeDisplay.textContent = t;
    vrTimeText.setAttribute('value', t);
};

seekBar.oninput = () => {
    video.currentTime = (seekBar.value / 100) * video.duration;
};

function fmt(s) {
    if (!s || isNaN(s)) return '00:00';
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}
</script>

</body>
</html>
